---
title: "Module6_bulk_vs_single"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
editor_options: 
  chunk_output_type: inline
---

Module 6 Overview

Compare bulk and scRNAseq data for a distinct cell type (e.g., Renca). Pseudobulk data is computed from scRNAseq data. 

Input:
- sc RNAseq (seuart object, preprocessed using module 1)
- bulk RNAseq (csv format)

Thoughts:
- how much intercellular variation do clonal cell popualtions experience i.e., how consistent is expression between clonal cells?
- How far can we downsample scRNA seq data while retaining strong correlation with bulk RNA  data?

```{r setup, include=FALSE}
rm(list = ls())

# LOAD LIBRARIES

# scRNAseq libraries
library(Seurat)
library(sctransform)
# library(sigPathway)
library(SCINA)

# Data wrangling libraries
library(plyr)
library(dplyr)
library(tidyr)
library(reshape2)

# Data visualization libraries
library(RColorBrewer)
library(ggplot2)
library(gridExtra)
library(DT)
library(flexdashboard)
library(ggpmisc)
library(ggExtra)
library(grid)
library(ggrepel)


# Other Libraries
library(future)
library(biomaRt)
library(AnnotationDbi)
library(org.Mm.eg.db)
library(org.Hs.eg.db)
```


```{r load data}

# specify cell of interest
cell_of_interest_sc <- "Renca"
cell_of_interest_bulk <- "Renca"

# specify pseudo bulk calculation method
pseudo_method <- "sum" # options: trimmean, median, sum

# bulk RNa seq data (csv file)
bulk_input <- read.csv("BulkRNAseq_RencaHA.csv", header = TRUE)
gene_header <- "gene_short_name"
expression_header <- "RHA_1"

# bulk_input <- read.csv("BulkRNAseq_quantileNormed_HAP1andHEK293T.csv")
# gene_header <- "MATRIX"
# expression_header <- "HAP1"




# sc RNA seq data (seurat object)
load("Module1_pilot2_complete_Mm.Rdata")
# load("Module1_pilot2_complete_Hs.Rdata")

# specifcy whether either sc or bulk expression data needs to be log transformed
log_sc <- TRUE
log_bulk<- TRUE


```

```{r bulk RNA seq assertions and prep}

# prep data for comparison

bulk_genes <- bulk_input[gene_header]
bulk_exp <- bulk_input[expression_header]

bulk_data <- data.frame(bulk_genes, bulk_exp)
colnames(bulk_data) <- c("genes", "bulk.expression")


```


```{r annotate cells and parse out cell of interest (for scRNA seq data)}

# This chunk must be customized depending on input (currently setup for pilot 1 and 2)

organisms <- c("Hs", "Mm")
cells_Hs <- c("HAP1", "293T")
cells_Mm <- c("3T3", "CGR8", "Renca", "N2A")

cells_shared <- c("HAP1", "293T", "Renca")
cells_all <- c(cells_Hs, cells_Mm)
cells_Mm_shared <- intersect(cells_Mm, cells_shared)
cells_Hs_shared <- intersect(cells_Hs, cells_shared)

df.identity <- data.frame(so@meta.data[["CellType"]], so@meta.data[["Organism"]])
colnames(df.identity) <- c("cell", "organism")

for (i in 1:dim(df.identity)[1]){
  for (k in 1:length(cells_all)){
    if (is.element(cells_all[k], cells_Hs)){
      current_org <- "Hs"
    } else if (is.element(cells_all[k], cells_Mm)) {
      current_org <- "Mm"
    }
    if (grepl(cells_all[k], as.vector(df.identity[i,"cell"])) & (as.vector(df.identity[i,"organism"]) == current_org)){
      df.identity[i,"cell_true"] <- cells_all[k]
    }
  }
}

so <- AddMetaData(
  object = so,
  metadata =  df.identity$cell_true,
  col.name = 'CellType_True'
)


so.subset <- subset(so, subset = CellType_True == cell_of_interest_sc)

```


```{r function to convert ENSEMBLE to SYMBOL}

 # for input seurat object, converts ENSEMBLE to SYMBOL (gene symbols)
ens2sym <- function(so, gNames.list){
  
  # var features
so_ens <- so@assays[["SCT"]]@var.features
so@assays[["SCT"]]@var.features <- as.vector((gNames.list[so_ens]))

# scale data
so_sd <- so@assays[["SCT"]]@scale.data
rownames(so_sd) <-  as.vector((gNames.list[rownames(so_sd)]))
so@assays[["SCT"]]@scale.data <- so_sd

# data
so_d <- so@assays[["SCT"]]@data
rownames(so_d) <-  as.vector((gNames.list[rownames(so_d)]))
so@assays[["SCT"]]@data <- so_d

# RNA counts
so_r <- so@assays[["RNA"]]@counts@Dimnames[[1]]
so_r <-  as.vector((gNames.list[so_r]))
so@assays[["RNA"]]@counts@Dimnames[[1]] <- so_r

# RNA data
so_rd <- so@assays[["RNA"]]@data@Dimnames[[1]]
so_rd <-  as.vector((gNames.list[so_rd]))
so@assays[["RNA"]]@data@Dimnames[[1]] <- so_rd

  return(so)
}


```


```{r convert scRNA ENSEMBLE to SYMBOL}

so.subset <-  ens2sym(so.subset, gNames.list)

```



```{r generate pseudobulk data from scRNAseq }

genes <- so.subset@assays[["RNA"]]@data@Dimnames[[1]]

count_matrix <- as.data.frame(as.matrix(so.subset@assays[["RNA"]]@counts))

if (pseudo_method == "sum"){
  gene_exp <- rowSums(count_matrix)
  
} else if (pseudo_method == "median"){
  # gene_exp <- rowSums(count_matrix)
  
  # gene_exp <- rowMedians(count_matrix)
   gene_exp <- apply(count_matrix, 1, median)
  
} else if (pseudo_method == "trimmean"){
  gene_exp <- apply(count_matrix, 1, mean, trim = 0.1)
  
}

pseudobulk_data <- data.frame(genes, gene_exp)
colnames(pseudobulk_data) <- c("genes", "pseudobulk.expression")


```


```{r match pseudo to bulk}

# join datasets on common genes

# pseudobulk_data <- pseudobulk_data %>% mutate(genes = tolower(genes))
# bulk_data <- bulk_data %>% mutate(genes = tolower(genes))
df <- join(bulk_data, pseudobulk_data, type = "inner", match = "all")

if (log_sc == TRUE){
  df$pseudobulk.expression_input <- log(df$pseudobulk.expression + 1)
} else {
    df$pseudobulk.expression_input <- df$pseudobulk.expression
}

if (log_bulk == TRUE){
  df$bulk.expression_input <- log(df$bulk.expression + 1)
} else {
    df$bulk.expression_input <- df$bulk.expression
}


```

```{r}

  # generate plots
  plt.pseudo_Vs_bulk <- ggplot(df, aes(pseudobulk.expression_input, bulk.expression_input)) +  
    geom_point() +
    geom_smooth(method='lm',formula=y~x) + 
    stat_poly_eq(formula = y~x, aes(label = paste(..rr.label.., sep = "~~~")), parse = TRUE) +        
    geom_smooth(method='lm',formula=y~x, col=rgb(.5,0,0,alpha=.8)) +
    xlab(paste(cell_of_interest_sc, "Pseudobulk Expression (scRNA-seq)")) + 
    ylab(paste(cell_of_interest_bulk, "Bulk Expression"))

  plt.pseudo_Vs_bulk  <- ggMarginal(plt.pseudo_Vs_bulk , type = "histogram")
```

```{r}

# print(plt.pseudo_Vs_bulk)
print(plt.pseudo_Vs_bulk)
```

