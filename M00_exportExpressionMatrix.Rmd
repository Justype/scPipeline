---
title: "Export Expression Matrix"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}

rm(list = setdiff(ls(), c("data.path", "user")))
invisible({gc()})

# initiate timer
start.time <- proc.time()

packages2load <- c("Seurat", "scater", "scMiko", "plyr", "dplyr", "tidyr", "reshape2", "tidyverse",
                   "DT", "flexdashboard")

# load packages
invisible({lapply(packages2load, library, character.only = TRUE)})

```



```{r parameter specification}



# Query input
# input.file <- "R189_M01_NM2_p12_Meso_061020.Rdata"
# input.file <- "R247_M01_NM2_p12_LungTrouble_061020.Rdata"
input.file <- "R6_M02_BC2_allGBM_271020.Rdata"

# save file
output.file <- "allGBM_cleanCluster_031120.csv"


# Data subsampling
subsample_factor <- 1 # OPTIONAL; range 0 to 1 (default = 1)

# specify cluster resolution
cluster.resolution <- 1

clean.clusters <- T

# subset data
subset.df <- NA

which.species <-  "Mm"

which.grouping <- "seurat_clusters"

```



```{r load data, warning = FALSE}

# Specify data directories
dir.preprocessed <- "Preprocessed_Datasets/"


if (!exists("data.path") & !exists("user")) {
  stop("data.path and user variables do not exist in global enviroment. Ensure that these are specified in .Rprofile. If specified, try restarting Rstudio.")
}

# load data
warning("Importing data...")
if (!grepl(".Rdata|.RData", input.file)) input.file <- paste0(input.file, ".Rdata")
load(paste(data.path, dir.preprocessed, input.file, sep = ""))


if (!exists("gNames.list")) gNames.list <- prepGeneList(so, objects())

if (!(exists("subset.df"))) subset.df <- "no.subset"

# prep seurat object
prep.list <- prepSeurat2(so, e2s = gNames.list, 
                         species = which.species, resolution= cluster.resolution, subset = subset.df, 
                         subsample = subsample_factor, M00_subgroup.path = "M00_subgroups.csv",
                         terms2drop = c("ica", "tsne", "nmf", "gsva", "deg"), rmv.pattern = "so", 
                         scale.reprocessed = F, neighbors.reprocessed = F, keep.default.assay.only = T)

# unpack results
if (exists("so")) try({rm(so)}, silent = T)
so.query <- prep.list$so
current.assay <- prep.list$assay
n.cells <- prep.list$n.cell
rm(prep.list)
invisible({gc()})

if (clean.clusters) so.query <- cleanCluster(so.query, return.plots = F)

# assert factor order
u.clust.meta <- unique(as.numeric(as.character(so.query@meta.data[["seurat_clusters"]])))
so.query@meta.data[["seurat_clusters"]] <- factor(so.query@meta.data[["seurat_clusters"]], 
                                                  levels = u.clust.meta[order(u.clust.meta)])
Idents(so.query) <- so.query@meta.data[["seurat_clusters"]]

```



```{r get and save expression matrix}

# expression matrix
e.mat <- aggGroupExpression(so.query, which.center = "mean", do.parallel = F, which.group = which.grouping)
cluster.order <- colnames(e.mat)[2:ncol(e.mat)]
cluster.order <- as.numeric(as.character(gsub("c", "", cluster.order)))
e.mat.2 <- signif(e.mat[ ,colnames(e.mat)[2:ncol(e.mat)][order(cluster.order)]], 3)
rownames(e.mat.2) <- e.mat$genes

if (!(grepl("csv", output.file))){
  output.file <- paste0(output.file, ".csv")
}

write.csv(e.mat.2, file = output.file, 
          row.names = T)
```